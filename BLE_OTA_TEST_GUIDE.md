# BLE OTA 测试网页使用指南

## 📋 前置要求

### 浏览器要求
- **Chrome 56+** (推荐)
- **Edge 79+**
- **Opera 43+**
- ❌ 不支持 Safari、Firefox

### 访问要求
- **HTTPS**: 必须通过 HTTPS 访问（localhost 除外）
- 如果本地测试，可以使用 `localhost` 或 `127.0.0.1`

### 设备要求
- ESP32-S3 设备已烧录固件并运行
- 设备正在广播 BLE 信号
- 设备名称: `ESP-C919` 或 `ESP_GATTS_DEMO`

## 🚀 使用步骤

### 1. 打开测试网页

#### 方式一：本地文件（最简单）
- 直接双击 `ble_ota_test.html` 文件
- 浏览器会自动打开（Chrome/Edge）

#### 方式二：本地服务器（推荐用于生产环境）
```bash
# 使用 Python 3
python -m http.server 8000

# 或使用 Node.js
npx http-server -p 8000
```
然后访问: `http://localhost:8000/ble_ota_test.html`

#### 方式三：HTTPS 服务器
- 将文件上传到支持 HTTPS 的服务器
- 通过 HTTPS 访问

### 2. 连接设备

1. 点击 **"连接设备"** 按钮
2. 浏览器会弹出设备选择对话框
3. 选择你的 ESP32-S3 设备（名称: ESP-C919 或 ESP_GATTS_DEMO）
4. 等待连接成功（状态显示 "✅ 已连接"）

**注意**: 
- 如果看不到设备，确保设备已启动并正在广播
- 如果连接失败，检查设备是否已被其他应用连接

### 3. 选择固件文件

1. 点击文件选择区域
2. 选择要升级的固件文件（`.bin` 格式）
3. 文件信息会显示在界面上

**固件文件位置**:
- 编译后的固件通常在: `build/gatt_server_demos.bin`
- 或使用 `idf.py build` 后生成的 `.bin` 文件

### 4. 开始升级

1. 点击 **"开始升级"** 按钮
2. 观察进度条和日志输出
3. 等待升级完成

**升级流程**:
1. 发送开始 OTA 命令
2. 按扇区发送固件数据（每扇区 4KB）
3. 发送停止 OTA 命令
4. 设备自动重启到新固件

### 5. 查看结果

- **成功**: 状态显示 "✅ 升级完成，设备将重启"
- **失败**: 查看日志中的错误信息

## 📊 界面说明

### 状态指示
- ⚫ **未连接**: 设备未连接
- ✅ **已连接**: 设备已连接，可以开始升级
- 📤 **正在升级**: OTA 升级进行中
- ❌ **连接失败/升级失败**: 出现错误

### 进度显示
- 实时显示传输进度百分比
- 显示当前扇区信息
- 显示已传输字节数

### 日志信息
- **蓝色**: 信息日志
- **绿色**: 成功日志
- **红色**: 错误日志
- **黄色**: 警告日志

## 🔧 故障排除

### 问题1: 浏览器不支持 Web Bluetooth
**解决方案**:
- 使用 Chrome 56+、Edge 79+ 或 Opera 43+
- 确保浏览器版本是最新的

### 问题2: 找不到设备
**可能原因**:
- 设备未启动
- 设备未在广播
- 设备已被其他应用连接
- 设备名称不匹配

**解决方案**:
- 检查设备是否正常运行
- 查看串口日志确认设备状态
- 断开其他应用的连接
- 确认设备名称是 `ESP-C919` 或 `ESP_GATTS_DEMO`

### 问题3: 连接失败
**可能原因**:
- 设备距离太远
- 蓝牙适配器问题
- 设备忙

**解决方案**:
- 靠近设备
- 重启浏览器
- 等待几秒后重试

### 问题4: 升级失败
**可能原因**:
- 固件文件损坏
- 固件大小超过分区限制
- 传输中断
- 设备内存不足

**解决方案**:
- 检查固件文件是否完整
- 确认固件大小不超过 3MB（OTA分区大小）
- 查看设备串口日志
- 重试升级

### 问题5: 进度卡住不动
**可能原因**:
- 连接中断
- 设备处理慢
- 网络问题

**解决方案**:
- 检查连接状态
- 查看日志中的错误信息
- 等待一段时间（大文件传输需要时间）
- 如果长时间无响应，取消后重试

## 📝 测试检查清单

- [ ] 浏览器支持 Web Bluetooth API
- [ ] 设备正常启动并广播
- [ ] 可以成功连接设备
- [ ] MTU 协商成功（日志中显示 MTU 值）
- [ ] 可以选择固件文件
- [ ] 开始命令发送成功
- [ ] 固件数据正常传输
- [ ] 进度条正常更新
- [ ] 停止命令发送成功
- [ ] 设备成功重启

## 🎯 测试建议

### 基础测试
1. 使用小固件文件（< 100KB）测试基本流程
2. 确认连接、传输、重启都正常

### 压力测试
1. 使用大固件文件（接近 3MB）测试
2. 测试传输稳定性
3. 测试错误恢复能力

### 边界测试
1. 测试固件大小刚好等于分区大小
2. 测试传输中断后的恢复
3. 测试多次连续升级

## 📚 技术细节

### 协议规范
- **服务UUID**: `0x8018`
- **接收固件特征**: `0x8020`
- **命令特征**: `0x8022`
- **扇区大小**: 4096 字节 (4KB)
- **MTU**: 默认 23，协商后可达 500

### 数据包格式
```
[扇区索引(2字节)] [包序号(1字节)] [数据...]
```

### 命令格式
- **开始命令**: `[0x01, 0x00, 固件大小(4字节小端序)]`
- **停止命令**: `[0x02, 0x00]`

## ⚠️ 注意事项

1. **固件大小限制**: 确保固件不超过 OTA 分区大小（3MB）
2. **连接稳定性**: 升级过程中保持设备靠近，避免连接中断
3. **不要断电**: 升级过程中不要断电或重启设备
4. **备份固件**: 建议保留可用的固件备份
5. **测试环境**: 首次使用建议在测试环境进行

## 🆘 获取帮助

如果遇到问题：
1. 查看浏览器控制台日志（F12）
2. 查看设备串口日志
3. 检查日志中的错误信息
4. 参考 `BLE_OTA_CLIENT_REQUIREMENTS.md` 文档

## 📞 技术支持

- ESP-IDF 文档: https://docs.espressif.com/projects/esp-idf/
- Web Bluetooth API: https://developer.mozilla.org/en-US/docs/Web/API/Web_Bluetooth_API

