<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32-S3 BLE OTA å‡çº§å·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .content {
            padding: 30px;
        }

        .section {
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #333;
            display: flex;
            align-items: center;
        }

        .section-title::before {
            content: '';
            width: 4px;
            height: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin-right: 10px;
            border-radius: 2px;
        }

        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            flex: 1;
            min-width: 150px;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(16, 185, 129, 0.4);
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(239, 68, 68, 0.4);
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        .file-input-wrapper input[type=file] {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .file-input-label {
            display: block;
            padding: 15px;
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #f9fafb;
        }

        .file-input-label:hover {
            border-color: #667eea;
            background: #f3f4f6;
        }

        .file-input-label.has-file {
            border-color: #10b981;
            background: #ecfdf5;
        }

        .status {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .status.connected {
            background: #ecfdf5;
            color: #065f46;
            border: 1px solid #10b981;
        }

        .status.disconnected {
            background: #fef2f2;
            color: #991b1b;
            border: 1px solid #ef4444;
        }

        .status.uploading {
            background: #eff6ff;
            color: #1e40af;
            border: 1px solid #3b82f6;
        }

        .progress-container {
            margin-top: 20px;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e5e7eb;
            border-radius: 15px;
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 12px;
        }

        .progress-text {
            margin-top: 10px;
            text-align: center;
            color: #6b7280;
            font-size: 14px;
        }

        .log-container {
            background: #1f2937;
            color: #e5e7eb;
            padding: 20px;
            border-radius: 8px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.6;
        }

        .log-entry {
            margin-bottom: 5px;
            padding: 5px;
            border-left: 3px solid transparent;
        }

        .log-entry.info {
            border-left-color: #3b82f6;
        }

        .log-entry.success {
            border-left-color: #10b981;
        }

        .log-entry.error {
            border-left-color: #ef4444;
        }

        .log-entry.warning {
            border-left-color: #f59e0b;
        }

        .device-info {
            background: #f9fafb;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            font-size: 14px;
        }

        .device-info-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .device-info-item:last-child {
            margin-bottom: 0;
        }

        .device-info-label {
            font-weight: 600;
            color: #6b7280;
        }

        .device-info-value {
            color: #111827;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ”· ESP32-S3 BLE OTA å‡çº§å·¥å…·</h1>
            <p>é€šè¿‡ Web Bluetooth API è¿›è¡Œå›ºä»¶å‡çº§</p>
        </div>

        <div class="content">
            <!-- è¿æ¥çŠ¶æ€ -->
            <div class="section">
                <div id="status" class="status disconnected">
                    âš« æœªè¿æ¥
                </div>
            </div>

            <!-- è®¾å¤‡è¿æ¥ -->
            <div class="section">
                <div class="section-title">è®¾å¤‡è¿æ¥</div>
                <div class="button-group">
                    <button id="connectBtn" class="btn-primary">è¿æ¥è®¾å¤‡</button>
                    <button id="disconnectBtn" class="btn-danger" disabled>æ–­å¼€è¿æ¥</button>
                </div>
                <div id="deviceInfo" class="device-info" style="display: none;">
                    <div class="device-info-item">
                        <span class="device-info-label">è®¾å¤‡åç§°:</span>
                        <span class="device-info-value" id="deviceName">-</span>
                    </div>
                    <div class="device-info-item">
                        <span class="device-info-label">MACåœ°å€:</span>
                        <span class="device-info-value" id="deviceAddress">-</span>
                    </div>
                    <div class="device-info-item">
                        <span class="device-info-label">MTU:</span>
                        <span class="device-info-value" id="deviceMTU">-</span>
                    </div>
                </div>
            </div>

            <!-- å›ºä»¶ä¸Šä¼  -->
            <div class="section">
                <div class="section-title">å›ºä»¶ä¸Šä¼ </div>
                <div class="file-input-wrapper">
                    <input type="file" id="firmwareFile" accept=".bin" />
                    <label for="firmwareFile" class="file-input-label" id="fileLabel">
                        ğŸ“ ç‚¹å‡»é€‰æ‹©å›ºä»¶æ–‡ä»¶ (.bin)
                    </label>
                </div>
                <div class="button-group" style="margin-top: 15px;">
                    <button id="uploadBtn" class="btn-success" disabled>å¼€å§‹å‡çº§</button>
                    <button id="cancelBtn" class="btn-secondary" disabled>å–æ¶ˆå‡çº§</button>
                </div>
            </div>

            <!-- è¿›åº¦æ˜¾ç¤º -->
            <div class="section" id="progressSection" style="display: none;">
                <div class="section-title">å‡çº§è¿›åº¦</div>
                <div class="progress-container">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill" style="width: 0%">0%</div>
                    </div>
                    <div class="progress-text" id="progressText">
                        å‡†å¤‡ä¸­...
                    </div>
                </div>
            </div>

            <!-- æ—¥å¿— -->
            <div class="section">
                <div class="section-title">æ“ä½œæ—¥å¿—</div>
                <div class="log-container" id="logContainer">
                    <div class="log-entry info">ç­‰å¾…æ“ä½œ...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // BLE UUIDå®šä¹‰
        const SERVICE_UUID = 0x8018;
        const RECV_FW_CHAR_UUID = 0x8020;
        const CMD_CHAR_UUID = 0x8022;
        // æ³¨æ„: Web Bluetooth API ä¸å…è®¸ç›´æ¥è®¿é—® CCC æè¿°ç¬¦
        // ä½¿ç”¨ startNotifications() æ—¶æµè§ˆå™¨ä¼šè‡ªåŠ¨å¤„ç†

        // å¸¸é‡
        const SECTOR_SIZE = 4096;  // æ‰‡åŒºå¤§å°ï¼š4KB
        const BLE_OTA_START_CMD = 0x0001;
        const BLE_OTA_STOP_CMD = 0x0002;
        const BLE_OTA_ACK_CMD = 0x0003;

        // å…¨å±€å˜é‡
        let device = null;
        let server = null;
        let otaService = null;
        let recvFwChar = null;
        let cmdChar = null;
        let currentMTU = 23;  // é»˜è®¤MTU
        let isUploading = false;
        let uploadCancelled = false;
        let firmwareData = null;
        let firmwareSize = 0;
        let uploadStartTime = 0;
        let supportsWriteWithoutResponse = false;

        // DOMå…ƒç´ 
        const connectBtn = document.getElementById('connectBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const uploadBtn = document.getElementById('uploadBtn');
        const cancelBtn = document.getElementById('cancelBtn');
        const firmwareFile = document.getElementById('firmwareFile');
        const fileLabel = document.getElementById('fileLabel');
        const statusDiv = document.getElementById('status');
        const deviceInfo = document.getElementById('deviceInfo');
        const progressSection = document.getElementById('progressSection');
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');
        const logContainer = document.getElementById('logContainer');

        // æ—¥å¿—å‡½æ•°
        function addLog(message, type = 'info') {
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            const timestamp = new Date().toLocaleTimeString();
            entry.textContent = `[${timestamp}] ${message}`;
            logContainer.appendChild(entry);
            logContainer.scrollTop = logContainer.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        // æ›´æ–°çŠ¶æ€
        function updateStatus(text, className) {
            statusDiv.textContent = text;
            statusDiv.className = `status ${className}`;
        }

        // æ›´æ–°è¿›åº¦
        function updateProgress(percent, text) {
            progressFill.style.width = `${percent}%`;
            progressFill.textContent = `${percent.toFixed(1)}%`;
            progressText.textContent = text || `å·²ä¼ è¾“: ${percent.toFixed(1)}%`;
        }

        // è¿æ¥è®¾å¤‡
        connectBtn.addEventListener('click', async () => {
            try {
                addLog('å¼€å§‹æ‰«æè®¾å¤‡...', 'info');
                updateStatus('ğŸ” æ­£åœ¨æ‰«æè®¾å¤‡...', 'disconnected');

                device = await navigator.bluetooth.requestDevice({
                    acceptAllDevices: true,
                    optionalServices: [SERVICE_UUID]
                });
                // device = await navigator.bluetooth.requestDevice({
                //     filters: [
                //         { name: 'ESP-C919' },
                //         { name: 'ESP_GATTS_DEMO' },
                //         { services: [SERVICE_UUID] }
                //     ],
                //     optionalServices: [SERVICE_UUID]
                // });

                addLog(`æ‰¾åˆ°è®¾å¤‡: ${device.name || 'æœªçŸ¥'}`, 'success');
                updateStatus('ğŸ”Œ æ­£åœ¨è¿æ¥...', 'disconnected');

                device.addEventListener('gattserverdisconnected', onDisconnected);

                server = await device.gatt.connect();
                addLog('GATTæœåŠ¡å™¨è¿æ¥æˆåŠŸ', 'success');

                // è·å–MTUï¼ˆå¦‚æœæ”¯æŒï¼‰
                if (server.mtu) {
                    currentMTU = server.mtu;
                    addLog(`MTU: ${currentMTU}`, 'info');
                }

                // è·å–OTAæœåŠ¡
                otaService = await server.getPrimaryService(SERVICE_UUID);
                addLog('OTAæœåŠ¡å‘ç°æˆåŠŸ', 'success');

                // è·å–ç‰¹å¾å€¼
                try {
                    recvFwChar = await otaService.getCharacteristic(RECV_FW_CHAR_UUID);
                    addLog(`æ¥æ”¶å›ºä»¶ç‰¹å¾è·å–æˆåŠŸ (UUID: 0x${RECV_FW_CHAR_UUID.toString(16)})`, 'success');
                } catch (e) {
                    addLog(`è·å–æ¥æ”¶å›ºä»¶ç‰¹å¾å¤±è´¥: ${e.message}`, 'error');
                    throw e;
                }
                
                try {
                    cmdChar = await otaService.getCharacteristic(CMD_CHAR_UUID);
                    addLog(`å‘½ä»¤ç‰¹å¾è·å–æˆåŠŸ (UUID: 0x${CMD_CHAR_UUID.toString(16)})`, 'success');
                } catch (e) {
                    addLog(`è·å–å‘½ä»¤ç‰¹å¾å¤±è´¥: ${e.message}`, 'error');
                    throw e;
                }
                
                // éªŒè¯ç‰¹å¾å€¼å±æ€§
                if (!cmdChar.properties.write && !cmdChar.properties.writeWithoutResponse) {
                    addLog('è­¦å‘Š: å‘½ä»¤ç‰¹å¾ä¸æ”¯æŒå†™å…¥', 'warning');
                }
                addLog(`å‘½ä»¤ç‰¹å¾å±æ€§: write=${cmdChar.properties.write}, writeWithoutResponse=${cmdChar.properties.writeWithoutResponse}`, 'info');

                // æ£€æŸ¥æ˜¯å¦æ”¯æŒæ— å“åº”å†™å…¥ï¼ˆæé«˜ä¼ è¾“é€Ÿåº¦ï¼‰
                supportsWriteWithoutResponse = recvFwChar.properties.writeWithoutResponse || 
                                              recvFwChar.properties.write;
                if (supportsWriteWithoutResponse) {
                    addLog('ç‰¹å¾å€¼æ”¯æŒæ— å“åº”å†™å…¥ï¼Œå°†ä½¿ç”¨å¿«é€Ÿä¼ è¾“æ¨¡å¼', 'info');
                } else {
                    addLog('ç‰¹å¾å€¼ä¸æ”¯æŒæ— å“åº”å†™å…¥ï¼Œä½¿ç”¨æ ‡å‡†å†™å…¥æ¨¡å¼', 'warning');
                }

                // å¯ç”¨é€šçŸ¥ - æ¥æ”¶å›ºä»¶ACK
                // æ³¨æ„: Web Bluetooth API ä¸å…è®¸ç›´æ¥å†™å…¥ CCC æè¿°ç¬¦
                // ç›´æ¥ä½¿ç”¨ startNotifications() å³å¯ï¼Œæµè§ˆå™¨ä¼šè‡ªåŠ¨å¤„ç† CCC
                try {
                    await recvFwChar.startNotifications();
                    recvFwChar.addEventListener('characteristicvaluechanged', handleFwAck);
                    addLog('æ¥æ”¶å›ºä»¶é€šçŸ¥å·²å¯ç”¨', 'success');
                } catch (e) {
                    addLog(`å¯ç”¨æ¥æ”¶å›ºä»¶é€šçŸ¥å¤±è´¥: ${e.message}`, 'error');
                }

                // å¯ç”¨é€šçŸ¥ - å‘½ä»¤ACK
                // æ³¨æ„: Web Bluetooth API ä¸å…è®¸ç›´æ¥å†™å…¥ CCC æè¿°ç¬¦
                // ç›´æ¥ä½¿ç”¨ startNotifications() å³å¯ï¼Œæµè§ˆå™¨ä¼šè‡ªåŠ¨å¤„ç† CCC
                try {
                    await cmdChar.startNotifications();
                    cmdChar.addEventListener('characteristicvaluechanged', handleCmdAck);
                    addLog('å‘½ä»¤é€šçŸ¥å·²å¯ç”¨', 'success');
                } catch (e) {
                    addLog(`å¯ç”¨å‘½ä»¤é€šçŸ¥å¤±è´¥: ${e.message}`, 'error');
                }

                // æ›´æ–°UI
                updateStatus('âœ… å·²è¿æ¥', 'connected');
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
                uploadBtn.disabled = false;

                // æ˜¾ç¤ºè®¾å¤‡ä¿¡æ¯
                document.getElementById('deviceName').textContent = device.name || 'æœªçŸ¥';
                document.getElementById('deviceAddress').textContent = device.id || 'æœªçŸ¥';
                document.getElementById('deviceMTU').textContent = currentMTU;
                deviceInfo.style.display = 'block';

                addLog('è®¾å¤‡è¿æ¥å®Œæˆï¼Œå¯ä»¥å¼€å§‹OTAå‡çº§', 'success');
            } catch (error) {
                addLog(`è¿æ¥å¤±è´¥: ${error.message}`, 'error');
                updateStatus('âŒ è¿æ¥å¤±è´¥', 'disconnected');
                device = null;
            }
        });

        // æ–­å¼€è¿æ¥
        disconnectBtn.addEventListener('click', async () => {
            if (device && device.gatt.connected) {
                try {
                    device.gatt.disconnect();
                    addLog('å·²æ–­å¼€è¿æ¥', 'info');
                } catch (e) {
                    addLog(`æ–­å¼€è¿æ¥å¤±è´¥: ${e.message}`, 'error');
                }
            }
            onDisconnected();
        });

        // æ–­å¼€è¿æ¥å¤„ç†
        function onDisconnected() {
            device = null;
            server = null;
            otaService = null;
            recvFwChar = null;
            cmdChar = null;

            updateStatus('âš« æœªè¿æ¥', 'disconnected');
            connectBtn.disabled = false;
            disconnectBtn.disabled = true;
            uploadBtn.disabled = true;
            deviceInfo.style.display = 'none';
            progressSection.style.display = 'none';
            isUploading = false;
            uploadCancelled = false;
        }

        // æ–‡ä»¶é€‰æ‹©
        firmwareFile.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                firmwareData = null;
                firmwareSize = file.size;
                fileLabel.textContent = `ğŸ“ ${file.name} (${(file.size / 1024).toFixed(2)} KB)`;
                fileLabel.classList.add('has-file');
                addLog(`å·²é€‰æ‹©å›ºä»¶: ${file.name}, å¤§å°: ${(file.size / 1024).toFixed(2)} KB`, 'info');
            }
        });

        // å¤„ç†å›ºä»¶ACK
        function handleFwAck(event) {
            const value = event.target.value;
            if (value.byteLength < 4) return;

            const sectorIndex = value.getUint16(0, true);
            const status = value.getUint16(2, true);
            const currentSector = value.getUint16(4, true);

            const statusText = {
                0x0000: 'æˆåŠŸ',
                0x0001: 'CRCé”™è¯¯',
                0x0002: 'æ‰‡åŒºç´¢å¼•é”™è¯¯',
                0x0003: 'é•¿åº¦é”™è¯¯'
            }[status] || 'æœªçŸ¥';

            if (status === 0x0000) {
                addLog(`æ‰‡åŒº ${sectorIndex} æ¥æ”¶æˆåŠŸ`, 'success');
            } else {
                addLog(`æ‰‡åŒº ${sectorIndex} æ¥æ”¶å¤±è´¥: ${statusText}`, 'error');
            }
        }

        // å¤„ç†å‘½ä»¤ACK
        let cmdAckPromise = null;
        let cmdAckResolve = null;

        function handleCmdAck(event) {
            const value = event.target.value;
            if (value.byteLength < 6) return;

            const ackCmdId = value.getUint16(0, true);
            const originalCmdId = value.getUint16(2, true);
            const status = value.getUint16(4, true);

            if (ackCmdId === BLE_OTA_ACK_CMD) {
                const cmdName = originalCmdId === BLE_OTA_START_CMD ? 'å¼€å§‹' : 
                               originalCmdId === BLE_OTA_STOP_CMD ? 'åœæ­¢' : 'æœªçŸ¥';
                const statusText = status === 0x0000 ? 'æˆåŠŸ' : 'å¤±è´¥';

                addLog(`${cmdName}å‘½ä»¤ACK: ${statusText}`, status === 0x0000 ? 'success' : 'error');

                if (cmdAckResolve) {
                    cmdAckResolve({ cmdId: originalCmdId, status: status });
                    cmdAckResolve = null;
                }
            }
        }

        // ç­‰å¾…å‘½ä»¤ACK
        function waitForCmdAck(timeout = 5000) {
            return new Promise((resolve, reject) => {
                cmdAckResolve = resolve;
                setTimeout(() => {
                    if (cmdAckResolve) {
                        cmdAckResolve = null;
                        reject(new Error('ç­‰å¾…ACKè¶…æ—¶'));
                    }
                }, timeout);
            });
        }

        // ç­‰å¾…å‘½ä»¤ACKï¼ˆåœæ­¢å‘½ä»¤ä½¿ç”¨æ›´é•¿çš„è¶…æ—¶æ—¶é—´ï¼‰
        function waitForStopCmdAck(timeout = 15000) {
            return new Promise((resolve, reject) => {
                cmdAckResolve = resolve;
                setTimeout(() => {
                    if (cmdAckResolve) {
                        cmdAckResolve = null;
                        reject(new Error('ç­‰å¾…ACKè¶…æ—¶ï¼ˆè®¾å¤‡å¯èƒ½æ­£åœ¨å¤„ç†æˆ–é‡å¯ï¼‰'));
                    }
                }, timeout);
            });
        }

        // å‘é€å¼€å§‹OTAå‘½ä»¤
        async function sendStartCommand() {
            const startCmd = new Uint8Array(6);
            startCmd[0] = BLE_OTA_START_CMD & 0xFF;
            startCmd[1] = (BLE_OTA_START_CMD >> 8) & 0xFF;
            startCmd[2] = firmwareSize & 0xFF;
            startCmd[3] = (firmwareSize >> 8) & 0xFF;
            startCmd[4] = (firmwareSize >> 16) & 0xFF;
            startCmd[5] = (firmwareSize >> 24) & 0xFF;

            addLog(`å‘é€å¼€å§‹OTAå‘½ä»¤ï¼Œå›ºä»¶å¤§å°: ${firmwareSize} å­—èŠ‚`, 'info');
            addLog(`å‘½ä»¤æ•°æ®: [0x${startCmd[0].toString(16).padStart(2, '0')} 0x${startCmd[1].toString(16).padStart(2, '0')} 0x${startCmd[2].toString(16).padStart(2, '0')} 0x${startCmd[3].toString(16).padStart(2, '0')} 0x${startCmd[4].toString(16).padStart(2, '0')} 0x${startCmd[5].toString(16).padStart(2, '0')}]`, 'info');
            
            try {
                await cmdChar.writeValue(startCmd);
                addLog('å¼€å§‹OTAå‘½ä»¤å·²å‘é€åˆ°è®¾å¤‡', 'success');
            } catch (error) {
                addLog(`å‘é€å¼€å§‹OTAå‘½ä»¤å¤±è´¥: ${error.message}`, 'error');
                return false;
            }

            // ç­‰å¾…ACK
            try {
                const ack = await waitForCmdAck();
                if (ack.status === 0x0000) {
                    addLog('å¼€å§‹OTAå‘½ä»¤æˆåŠŸï¼Œè®¾å¤‡å·²ç¡®è®¤', 'success');
                    return true;
                } else {
                    addLog(`å¼€å§‹OTAå‘½ä»¤è¢«æ‹’ç»ï¼ŒçŠ¶æ€ç : 0x${ack.status.toString(16)}`, 'error');
                    return false;
                }
            } catch (e) {
                addLog(`ç­‰å¾…å¼€å§‹å‘½ä»¤ACKè¶…æ—¶: ${e.message}`, 'warning');
                addLog('æ³¨æ„: è®¾å¤‡å¯èƒ½ä¸æ”¯æŒACKï¼Œç»§ç»­å°è¯•å‘é€æ•°æ®...', 'warning');
                // ç­‰å¾…ä¸€å°æ®µæ—¶é—´è®©è®¾å¤‡å¤„ç†å‘½ä»¤
                await new Promise(resolve => setTimeout(resolve, 500));
                // ç»§ç»­æ‰§è¡Œï¼ŒæŸäº›è®¾å¤‡å¯èƒ½ä¸å‘é€ACK
                return true;
            }
        }

        // å‘é€åœæ­¢OTAå‘½ä»¤
        async function sendStopCommand() {
            // ç­‰å¾…ä¸€å°æ®µæ—¶é—´ï¼Œç¡®ä¿æœ€åä¸€ä¸ªæ‰‡åŒºå¤„ç†å®Œæˆ
            addLog('ç­‰å¾…è®¾å¤‡å¤„ç†æœ€åä¸€ä¸ªæ‰‡åŒº...', 'info');
            await new Promise(resolve => setTimeout(resolve, 1000));

            const stopCmd = new Uint8Array([BLE_OTA_STOP_CMD & 0xFF, (BLE_OTA_STOP_CMD >> 8) & 0xFF]);
            addLog('å‘é€åœæ­¢OTAå‘½ä»¤', 'info');
            await cmdChar.writeValue(stopCmd);

            // ç­‰å¾…ACKï¼ˆä½¿ç”¨æ›´é•¿çš„è¶…æ—¶æ—¶é—´ï¼Œå› ä¸ºè®¾å¤‡éœ€è¦å¤„ç†å¹¶å¯èƒ½é‡å¯ï¼‰
            try {
                const ack = await waitForStopCmdAck(15000);
                if (ack.status === 0x0000) {
                    addLog('åœæ­¢OTAå‘½ä»¤æˆåŠŸï¼Œè®¾å¤‡å°†é‡å¯', 'success');
                    return true;
                } else {
                    addLog('åœæ­¢OTAå‘½ä»¤å¤±è´¥', 'error');
                    return false;
                }
            } catch (e) {
                addLog(`ç­‰å¾…åœæ­¢å‘½ä»¤ACKè¶…æ—¶: ${e.message}`, 'warning');
                addLog('æ³¨æ„: è®¾å¤‡å¯èƒ½æ­£åœ¨å¤„ç†å›ºä»¶æˆ–å·²å¼€å§‹é‡å¯', 'info');
                addLog('å¦‚æœè®¾å¤‡é‡å¯ï¼Œè¯´æ˜å‡çº§å¯èƒ½å·²æˆåŠŸ', 'info');
                // å³ä½¿è¶…æ—¶ä¹Ÿè¿”å›trueï¼Œå› ä¸ºæ•°æ®å·²å…¨éƒ¨å‘é€å®Œæˆ
                return true;
            }
        }

        // å‘é€å›ºä»¶æ•°æ®
        async function sendFirmwareData() {
            if (!firmwareData) {
                throw new Error('å›ºä»¶æ•°æ®æœªåŠ è½½');
            }

            // ä¼˜åŒ–ï¼šä½¿ç”¨æœ€å¤§å¯èƒ½çš„MTUï¼Œå‡å»åè®®å¤´ï¼ˆæ‰‡åŒºç´¢å¼•2å­—èŠ‚ + åŒ…åºå·1å­—èŠ‚ï¼‰
            const maxDataPerPacket = Math.min(currentMTU - 3, 497);  // ç¡®ä¿ä¸è¶…è¿‡BLEé™åˆ¶
            const totalSectors = Math.ceil(firmwareSize / SECTOR_SIZE);
            let totalSent = 0;
            let lastProgressUpdate = 0;
            const PROGRESS_UPDATE_INTERVAL = 50;  // æ¯50ä¸ªåŒ…æ›´æ–°ä¸€æ¬¡è¿›åº¦

            uploadStartTime = Date.now();
            addLog(`å¼€å§‹å‘é€å›ºä»¶ï¼Œå…± ${totalSectors} ä¸ªæ‰‡åŒºï¼Œæ¯åŒ…æœ€å¤§ ${maxDataPerPacket} å­—èŠ‚`, 'info');
            if (supportsWriteWithoutResponse) {
                addLog('ä½¿ç”¨æ— å“åº”å†™å…¥æ¨¡å¼ä»¥æé«˜ä¼ è¾“é€Ÿåº¦', 'info');
            } else {
                addLog('ä½¿ç”¨æ ‡å‡†å†™å…¥æ¨¡å¼ï¼ˆè¾ƒæ…¢ï¼‰', 'warning');
            }

            for (let sectorIndex = 0; sectorIndex < totalSectors; sectorIndex++) {
                if (uploadCancelled) {
                    addLog('ç”¨æˆ·å–æ¶ˆå‡çº§', 'warning');
                    throw new Error('å‡çº§å·²å–æ¶ˆ');
                }

                const sectorOffset = sectorIndex * SECTOR_SIZE;
                const sectorData = firmwareData.slice(sectorOffset, sectorOffset + SECTOR_SIZE);
                const sectorLength = sectorData.length;
                const isLastSector = (sectorOffset + sectorLength >= firmwareSize);

                let packetSeq = 0;
                const packetsInSector = Math.ceil(sectorLength / maxDataPerPacket);
                
                // æ‰¹é‡å‘é€åŒ…ï¼Œå‡å°‘ç­‰å¾…æ—¶é—´
                for (let offset = 0; offset < sectorLength; offset += maxDataPerPacket) {
                    if (uploadCancelled) {
                        throw new Error('å‡çº§å·²å–æ¶ˆ');
                    }

                    const packetData = sectorData.slice(offset, offset + maxDataPerPacket);
                    const isLastPacket = (offset + packetData.length >= sectorLength);

                    // æ„å»ºæ•°æ®åŒ…: [æ‰‡åŒºç´¢å¼•(2å­—èŠ‚), åŒ…åºå·(1å­—èŠ‚), æ•°æ®...]
                    const packet = new Uint8Array(3 + packetData.length);
                    packet[0] = sectorIndex & 0xFF;
                    packet[1] = (sectorIndex >> 8) & 0xFF;
                    packet[2] = isLastPacket ? 0xFF : packetSeq;
                    packet.set(packetData, 3);

                    // ä½¿ç”¨ writeValueWithoutResponse æé«˜é€Ÿåº¦ï¼ˆä¸éœ€è¦ç­‰å¾…å“åº”ï¼‰
                    if (supportsWriteWithoutResponse && recvFwChar.properties.writeWithoutResponse) {
                        await recvFwChar.writeValueWithoutResponse(packet);
                    } else {
                        // å›é€€åˆ°æ™®é€šå†™å…¥ï¼ˆéœ€è¦ç­‰å¾…å“åº”ï¼Œè¾ƒæ…¢ï¼‰
                        await recvFwChar.writeValue(packet);
                    }
                    
                    totalSent += packetData.length;
                    packetSeq++;

                    // é™ä½è¿›åº¦æ›´æ–°é¢‘ç‡ï¼Œæé«˜æ€§èƒ½
                    if (packetSeq - lastProgressUpdate >= PROGRESS_UPDATE_INTERVAL || isLastPacket) {
                        const percent = (totalSent / firmwareSize) * 100;
                        updateProgress(percent, `æ‰‡åŒº ${sectorIndex + 1}/${totalSectors}, å·²å‘é€: ${totalSent}/${firmwareSize} å­—èŠ‚`);
                        lastProgressUpdate = packetSeq;
                    }

                    // ä¼˜åŒ–ï¼šå‡å°‘å»¶è¿Ÿä»¥æé«˜ä¼ è¾“é€Ÿåº¦
                    // æ¯20ä¸ªåŒ…æ‰å»¶è¿Ÿä¸€æ¬¡ï¼ˆå‡å°‘å»¶è¿Ÿé¢‘ç‡ï¼‰
                    if (packetSeq % 20 === 0 && !isLastPacket) {
                        // ä½¿ç”¨æçŸ­çš„å»¶è¿Ÿï¼Œä»…è®©æµè§ˆå™¨å¤„ç†å…¶ä»–ä»»åŠ¡
                        await new Promise(resolve => setTimeout(resolve, 0));
                    }
                }

                // ä¼˜åŒ–ï¼šå‡å°‘æ‰‡åŒºé—´çš„ç­‰å¾…æ—¶é—´
                // åªåœ¨éæœ€åä¸€ä¸ªæ‰‡åŒºæ—¶çŸ­æš‚ç­‰å¾…ï¼Œç¡®ä¿è®¾å¤‡æœ‰æ—¶é—´å¤„ç†
                if (!isLastSector) {
                    await new Promise(resolve => setTimeout(resolve, 2));  // ä»5mså‡å°‘åˆ°2ms
                }
                
                // æ¯10ä¸ªæ‰‡åŒºè¾“å‡ºä¸€æ¬¡æ—¥å¿—ï¼Œå‡å°‘æ—¥å¿—è¾“å‡º
                if ((sectorIndex + 1) % 10 === 0 || isLastSector) {
                    addLog(`æ‰‡åŒº ${sectorIndex + 1}/${totalSectors} å‘é€å®Œæˆ`, 'info');
                }
            }

            // æœ€ç»ˆè¿›åº¦æ›´æ–°
            const uploadTime = (Date.now() - uploadStartTime) / 1000;  // ç§’
            const uploadSpeed = (totalSent / uploadTime / 1024).toFixed(2);  // KB/s
            updateProgress(100, `æ‰€æœ‰æ‰‡åŒºå‘é€å®Œæˆ: ${totalSent}/${firmwareSize} å­—èŠ‚`);
            addLog(`æ‰€æœ‰å›ºä»¶æ•°æ®å‘é€å®Œæˆï¼Œè€—æ—¶: ${uploadTime.toFixed(2)} ç§’ï¼Œå¹³å‡é€Ÿåº¦: ${uploadSpeed} KB/s`, 'success');
        }

        // å¼€å§‹OTAå‡çº§
        uploadBtn.addEventListener('click', async () => {
            if (!device || !device.gatt.connected) {
                addLog('è¯·å…ˆè¿æ¥è®¾å¤‡', 'error');
                return;
            }

            const file = firmwareFile.files[0];
            if (!file) {
                addLog('è¯·é€‰æ‹©å›ºä»¶æ–‡ä»¶', 'error');
                return;
            }

            try {
                isUploading = true;
                uploadCancelled = false;
                uploadBtn.disabled = true;
                cancelBtn.disabled = false;
                progressSection.style.display = 'block';
                updateStatus('ğŸ“¤ æ­£åœ¨å‡çº§...', 'uploading');
                updateProgress(0, 'å‡†å¤‡ä¸­...');

                // è¯»å–å›ºä»¶æ–‡ä»¶
                addLog('æ­£åœ¨è¯»å–å›ºä»¶æ–‡ä»¶...', 'info');
                const arrayBuffer = await file.arrayBuffer();
                firmwareData = new Uint8Array(arrayBuffer);
                firmwareSize = firmwareData.length;
                addLog(`å›ºä»¶æ–‡ä»¶è¯»å–å®Œæˆï¼Œå¤§å°: ${(firmwareSize / 1024).toFixed(2)} KB`, 'success');

                // 1. å‘é€å¼€å§‹å‘½ä»¤ï¼ˆå¿…é¡»æˆåŠŸæ‰èƒ½ç»§ç»­ï¼‰
                addLog('å‡†å¤‡å‘é€å¼€å§‹OTAå‘½ä»¤...', 'info');
                const startSuccess = await sendStartCommand();
                if (!startSuccess) {
                    addLog('å¼€å§‹OTAå‘½ä»¤å¤±è´¥ï¼Œæ— æ³•ç»§ç»­å‡çº§', 'error');
                    throw new Error('å¼€å§‹OTAå‘½ä»¤å¤±è´¥ï¼Œè®¾å¤‡æœªå‡†å¤‡å¥½æ¥æ”¶å›ºä»¶');
                }
                
                // ç­‰å¾…ä¸€å°æ®µæ—¶é—´ç¡®ä¿è®¾å¤‡å¤„ç†å¼€å§‹å‘½ä»¤
                addLog('ç­‰å¾…è®¾å¤‡å¤„ç†å¼€å§‹å‘½ä»¤...', 'info');
                await new Promise(resolve => setTimeout(resolve, 200));

                // 2. å‘é€å›ºä»¶æ•°æ®
                await sendFirmwareData();

                // 3. å‘é€åœæ­¢å‘½ä»¤
                const stopSuccess = await sendStopCommand();

                if (stopSuccess) {
                    updateStatus('âœ… å‡çº§å®Œæˆï¼Œè®¾å¤‡å°†é‡å¯', 'connected');
                    updateProgress(100, 'å‡çº§å®Œæˆï¼');
                    addLog('OTAå‡çº§æµç¨‹å®Œæˆ', 'success');
                    addLog('è¯·è§‚å¯Ÿè®¾å¤‡æ˜¯å¦é‡å¯ï¼Œå¦‚æœè®¾å¤‡é‡å¯åˆ°æ–°å›ºä»¶ï¼Œè¯´æ˜å‡çº§æˆåŠŸ', 'info');
                } else {
                    updateStatus('âš ï¸ å‡çº§å¯èƒ½å®Œæˆï¼Œè¯·æ£€æŸ¥è®¾å¤‡çŠ¶æ€', 'disconnected');
                    updateProgress(100, 'æ•°æ®å·²å…¨éƒ¨å‘é€');
                    addLog('æ‰€æœ‰æ•°æ®å·²å‘é€ï¼Œä½†åœæ­¢å‘½ä»¤å“åº”å¼‚å¸¸', 'warning');
                    addLog('è¯·æ£€æŸ¥è®¾å¤‡æ˜¯å¦é‡å¯ï¼Œæˆ–æŸ¥çœ‹è®¾å¤‡ä¸²å£æ—¥å¿—', 'info');
                }

            } catch (error) {
                addLog(`å‡çº§å¤±è´¥: ${error.message}`, 'error');
                updateStatus('âŒ å‡çº§å¤±è´¥', 'disconnected');
                if (error.message !== 'å‡çº§å·²å–æ¶ˆ') {
                    updateProgress(0, 'å‡çº§å¤±è´¥');
                }
            } finally {
                isUploading = false;
                uploadBtn.disabled = false;
                cancelBtn.disabled = true;
            }
        });

        // å–æ¶ˆå‡çº§
        cancelBtn.addEventListener('click', () => {
            uploadCancelled = true;
            addLog('æ­£åœ¨å–æ¶ˆå‡çº§...', 'warning');
        });

        // æ£€æŸ¥Web Bluetoothæ”¯æŒ
        if (!navigator.bluetooth) {
            addLog('é”™è¯¯: æµè§ˆå™¨ä¸æ”¯æŒ Web Bluetooth API', 'error');
            addLog('è¯·ä½¿ç”¨ Chrome 56+, Edge 79+, æˆ– Opera 43+', 'error');
            updateStatus('âŒ æµè§ˆå™¨ä¸æ”¯æŒ', 'disconnected');
            connectBtn.disabled = true;
        } else {
            addLog('Web Bluetooth API å¯ç”¨', 'success');
        }
    </script>
</body>
</html>

